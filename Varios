# LaboratorioCorreo - Librería de Envío de Correos Davivienda

**Autor:** Carlos Ardón  
**Namespace:** `LaboratorioCorreo.Service`  
**Plataforma:** .NET (C#)

---

## Descripción

Librería para el envío de correos electrónicos a través del servicio SOAP de Souma (Buzón SP) de Davivienda Honduras. Permite crear solicitudes de correo, agregar contenido con formato HTML, adjuntar archivos en Base64 y gestionar el envío de manera asíncrona.

## Dependencias

```
AsmxServiceReference
AsmxServiceSdk
System.ServiceModel
```

## Clases Principales

### `SoumaSender`

Clase principal que encapsula el flujo completo de envío de correos.

### `EmailSenderClient`

Cliente SOAP que se conecta al servicio de correo de Souma. Expone los siguientes métodos:

| Método | Descripción |
|--------|-------------|
| `CreateMailAsync(...)` | Crea una solicitud de correo y devuelve un `GUIDCode` y `ShippingDate` |
| `AddTextAsync(...)` | Agrega asunto y cuerpo HTML al correo |
| `Base64AttachAsync(...)` | Adjunta archivos codificados en Base64 |
| `SendMailAsync(...)` | Envía el correo previamente configurado |

### `CreateMailRequestBody`

Modelo de configuración para la solicitud de correo:

| Propiedad | Tipo | Descripción | Ejemplo |
|-----------|------|-------------|---------|
| `Origin` | `string` | Identificador del origen del correo | `"TEST BUZON SP"` |
| `System` | `string` | Código del sistema emisor | `"019"` |
| `Template` | `string` | Código de plantilla de correo | `"007"` |
| `Adresses` | `string` | Dirección(es) de correo destinatario | `"usuario@davivienda.com.hn"` |
| `ParameterList` | `string` | Lista de parámetros adicionales (separados por delimitador) | `""` |
| `HoldMailShipment` | `string` | Indica si se retiene el envío (`"SI"` / `"NO"`) | `"SI"` |

### `CreateMailResponse`

Respuesta de la creación del correo:

| Propiedad | Descripción |
|-----------|-------------|
| `Body.CreateMailResult.GUIDCode` | Identificador único del correo creado |
| `Body.CreateMailResult.ShippingDate` | Fecha de envío asignada |

### `SendMailResponse`

Respuesta del envío:

| Propiedad | Descripción |
|-----------|-------------|
| `Body.SendMailResult.ProcessResult` | Resultado del proceso de envío |

---

## Uso Básico

### 1. Envío de correo con cuerpo HTML

```csharp
public async Task EnviarCorreo()
{
    string correo = "destinatario@davivienda.com.hn";

    // Instancia del cliente
    EmailSenderClient client = new EmailSenderClient();
    CreateMailRequestBody mailRequest = new CreateMailRequestBody();
    mailRequest.Origin = "TEST BUZON SP";
    mailRequest.System = "019";
    mailRequest.Template = "007";
    mailRequest.Adresses = correo;
    mailRequest.ParameterList = "";
    mailRequest.HoldMailShipment = "SI";

    // Crear solicitud de correo
    CreateMailResponse req = await client.CreateMailAsync(
        mailRequest.Origin,
        mailRequest.System,
        mailRequest.Template,
        mailRequest.Adresses,
        mailRequest.ParameterList,
        mailRequest.HoldMailShipment
    );

    var guidCode = req.Body.CreateMailResult.GUIDCode;
    var shippingDate = req.Body.CreateMailResult.ShippingDate;

    // Agregar asunto y cuerpo HTML
    await client.AddTextAsync(
        guidCode,
        shippingDate,
        "Asunto del correo",
        "Cuerpo del correo con <b>formato HTML</b>"
    );

    // Enviar correo
    var response = await client.SendMailAsync(guidCode, shippingDate);

    Console.WriteLine($"Resultado: {response.Body.SendMailResult.ProcessResult} "
        + $"GUID: {req.Body.CreateMailResult.GUIDCode} "
        + $"FECHA: {req.Body.CreateMailResult.ShippingDate}");
}
```

### 2. Envío con archivo adjunto (Base64)

```csharp
// Después de crear el correo y obtener guidCode/shippingDate:

byte[] fileBytes = File.ReadAllBytes(@"\\servidor\ruta\archivo.txt");
var base64 = Convert.ToBase64String(fileBytes);

await client.Base64AttachAsync(
    guidCode,
    shippingDate,
    base64,
    "NombreArchivo.txt"
);

// Luego enviar normalmente
var response = await client.SendMailAsync(guidCode, shippingDate);
```

---

## Flujo de Envío

```
1. CreateMailAsync()     → Crea la solicitud, obtiene GUIDCode + ShippingDate
2. AddTextAsync()        → Asigna asunto y cuerpo HTML
3. Base64AttachAsync()   → (Opcional) Adjunta archivos en Base64
4. SendMailAsync()       → Ejecuta el envío del correo
```

## Notas Importantes

- El campo `HoldMailShipment` en `"SI"` permite agregar contenido y adjuntos antes de enviar. Configurar en `"NO"` envía el correo inmediatamente al crearlo.
- El cuerpo del correo soporta etiquetas HTML básicas (`<b>`, `<i>`, `<br>`, etc.).
- Los archivos adjuntos deben enviarse codificados en Base64 mediante `Convert.ToBase64String()`.
- El `GUIDCode` y `ShippingDate` son requeridos en todas las operaciones posteriores a la creación del correo.
- Las direcciones de correo se configuran en la propiedad `Adresses` (con una sola 'd', tal como lo define el servicio SOAP).

## Configuración del Servicio

La conexión al servicio SOAP se gestiona a través de `System.ServiceModel`. Asegúrese de tener configurado el endpoint del servicio en el archivo `app.config` o `web.config` del proyecto consumidor, o bien configurar el binding programáticamente en `EmailSenderClient`.

---

*Última actualización: Febrero 2026*
